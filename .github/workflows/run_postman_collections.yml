name: "Run postman collection"
permissions: 
    pull-requests: write 
on:
  workflow_call:
    inputs:
        collection_id:
            description: "Postman collection ID to run"
            type: string
            required: true 
        postman_env_id:
                description: "Postman env ID"
                type: string
                required: false
                default: "none"
    secrets:
        postman_api_key:
            description: "Postman env ID"
            required: true

                
jobs:
    run_postman_collection:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            
            - uses: actions/setup-node@v4
              with:
                node-version: 18
            - run: npm install -g newman

            - name: Run without env
              run: newman run "https://api.postman.com/collections/${{inputs.collection_id}}?apikey=${{ secrets.postman_api_key }}" -r junit --reporter-junit-export report.xml
              if: ${{ github.event.inputs.postman_env_id == 'none' }}

            - name: Run with env
              run: newman run "https://api.postman.com/collections/${{inputs.collection_id}}?apikey=${{ secrets.postman_api_key }}"  --environment "https://api.getpostman.com/environments/${{inputs.postman_env_id}}?apikey=${{ secrets.postman_api_key }}" -r junit --reporter-junit-export report.xml
              if: ${{ github.event.inputs.postman_env_id != 'none' }}
            
            - name: Comment with the result
              uses: thollander/actions-comment-pull-request@v2
              with:
                filePath: ./report.xml
                pr_number: 1
            
            